<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>주소 시각화 및 구역 관리 시스템</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>body{font-family:'Noto Sans KR',sans-serif;overflow:hidden;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#map{width:100%;height:100%}.list-row:hover{background-color:#f3f4f6;cursor:pointer}.selected-row{background-color:#eff6ff!important;border-left:4px solid #2563eb}.no-marker-row{background-color:#fff1f2}input[type="checkbox"]{cursor:pointer}.tree-item{transition:all .2s}.tree-header:hover{background-color:#f9fafb}th{white-space:nowrap;position:relative}.resizer{position:absolute;top:0;right:0;width:4px;cursor:col-resize;user-select:none;height:100%;background-color:transparent;z-index:10}.resizer:hover,.resizing{background-color:#3b82f6;width:4px}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#f1f1f1}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#94a3b8}</style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
<header class="bg-white shadow-sm px-6 py-3 z-20 flex justify-between items-center h-14 shrink-0 border-b">
<div class="flex items-center gap-4"><h1 class="text-lg font-bold text-gray-800 flex items-center"><i class="fa-solid fa-map-location-dot text-blue-600 text-xl mr-2"></i>구역 관리</h1><div class="h-6 w-px bg-gray-300 mx-2"></div><div class="flex items-center gap-2"><button onclick="downloadSample()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1.5 rounded text-sm cursor-pointer flex items-center shadow-sm transition"><i class="fa-solid fa-download mr-2"></i>양식 다운로드</button><input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(event)"><label for="excelFile" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm cursor-pointer flex items-center shadow-sm transition"><i class="fa-solid fa-file-excel mr-2"></i>엑셀 업로드</label><span id="statusMsg" class="text-xs text-gray-500 ml-2">준비됨</span></div></div>
<button onclick="resetAll()" class="text-xs bg-white border border-gray-300 hover:bg-red-50 text-gray-600 px-3 py-1.5 rounded transition"><i class="fa-solid fa-rotate-right mr-1 text-red-400"></i>초기화</button>
</header>
<main class="flex flex-1 overflow-hidden">
<div id="map-container" class="w-[65%] h-full relative bg-gray-100 border-r"><div id="map"></div></div>
<div class="w-[35%] flex flex-col bg-white h-full shadow-xl z-30">
<div class="h-[40%] flex flex-col border-b bg-white"><div class="p-3 border-b bg-gray-50 font-bold text-gray-700 text-sm flex justify-between items-center"><span><i class="fa-solid fa-sitemap mr-2 text-blue-500"></i>조직 통계 및 필터</span><span class="text-xs font-normal bg-white border px-2 py-0.5 rounded text-gray-500">총원: <span id="totalCount">0</span>명</span></div><div id="statsTreeContainer" class="flex-1 overflow-y-auto p-2 space-y-2"><div class="text-center py-10 text-gray-400 text-xs">데이터를 업로드하세요.</div></div></div>
<div class="bg-blue-50 border-b border-blue-100 p-3 shrink-0 transition-all" id="selectionSummaryPanel"><div class="flex justify-between items-center mb-1"><span class="text-xs font-bold text-blue-800"><i class="fa-solid fa-check-double mr-1"></i>현재 체크된 인원 현황</span><span class="text-xs font-bold text-blue-600"><span id="selectedCount">0</span>명</span></div><div id="selectionTags" class="flex flex-wrap gap-1 max-h-[60px] overflow-y-auto text-[10px]"><span class="text-gray-400 px-1">선택된 인원이 없습니다.</span></div></div>
<div class="flex-1 flex flex-col overflow-hidden"><div class="p-2 bg-gray-50 border-b text-xs font-bold text-gray-600 flex justify-between items-center"><div class="flex items-center gap-2"><input type="checkbox" id="checkAll" onchange="toggleAll(this.checked)" checked class="rounded text-blue-600 focus:ring-0"><label for="checkAll" class="cursor-pointer">전체 선택/해제</label></div><span id="currentFilterName" class="font-normal text-gray-400">전체 목록</span></div>
<div class="flex-1 overflow-y-auto overflow-x-auto"><table id="resizeTable" class="w-full text-sm text-left border-collapse table-fixed min-w-[400px]"><thead class="text-xs text-gray-500 uppercase bg-white sticky top-0 z-10 shadow-sm select-none"><tr><th class="px-2 py-2 border-b w-8 text-center"><i class="fa-solid fa-check text-gray-300"></i></th><th class="px-2 py-2 border-b w-20 text-center">교구/구역<div class="resizer"></div></th><th class="px-2 py-2 border-b w-20">이름<div class="resizer"></div></th><th class="px-2 py-2 border-b w-16">직분<div class="resizer"></div></th><th class="px-2 py-2 border-b">주소<div class="resizer"></div></th><th class="px-2 py-2 border-b w-12 text-center">출석<div class="resizer"></div></th></tr></thead><tbody id="personList" class="divide-y divide-gray-100"></tbody></table></div></div></div>
</main>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=1d9268593ca620c81ee6929f1f2de6a3&libraries=services&autoload=false"></script>
<script>
(function(_w,_d){
    // --- 보안(우클릭/F12 방지) ---
    _d.addEventListener('contextmenu',e=>e.preventDefault());
    _d.addEventListener('keydown',e=>{if(e.key=='F12'||(e.ctrlKey&&e.shiftKey&&e.key=='I'))e.preventDefault()});

    // --- 난독화된 전역 변수 ---
    let _M,_G,_D=[],_S={},_SM=null;
    const _PC={'1교구':{h:'#2563EB',l:'bg-blue-500'},'2교구':{h:'#DC2626',l:'bg-red-500'},'3교구':{h:'#16A34A',l:'bg-green-500'},'4교구':{h:'#CA8A04',l:'bg-yellow-500'},'default':{h:'#6B7280',l:'bg-gray-500'}};
    
    // --- 초기화 ---
    _w.onload=function(){
        _ITR();
        if(!_w.kakao||!_w.kakao.maps){alert("\uC548\uB098: API \uD0A4 \uC624\uB958");return}
        kakao.maps.load(function(){
            _M=new kakao.maps.Map(_d.getElementById('map'),{center:new kakao.maps.LatLng(37.566826,126.9786567),level:7});
            _G=new kakao.maps.services.Geocoder();
        });
    };

    // --- 내부 함수 (암호화) ---
    function _ITR(){
        const t=_d.getElementById('resizeTable'),c=t.querySelectorAll('th');
        c.forEach(h=>{
            const r=h.querySelector('.resizer');if(!r)return;
            let x=0,w=0;
            const md=e=>{x=e.clientX;w=parseInt(_w.getComputedStyle(h).width,10);_d.addEventListener('mousemove',mm);_d.addEventListener('mouseup',mu);r.classList.add('resizing')};
            const mm=e=>{h.style.width=`${w+e.clientX-x}px`};
            const mu=()=>{_d.removeEventListener('mousemove',mm);_d.removeEventListener('mouseup',mu);r.classList.remove('resizing')};
            r.addEventListener('mousedown',md);
        });
    }

    // --- 공개 함수 (HTML 바인딩용) ---
    _w.downloadSample=function(){
        const d=[{'\uC774\uB984':'\uD64D\uAE38\uB3D9','\uC8FC\uC18C':'\uC11C\uC6B8\uD2B9\uBCC4\uC2DC \uC911\uAD6C \uC138\uC885\uB300\uB85C 110','\uAD50\uAD6C':'1\uAD50\uAD6C','\uAD6C\uC5ED':'1\uAD6C\uC5ED','\uC18C\uC18D':'\uBD09\uC0AC\uD68C','\uC9C1\uBD84':'\uD300\uC7A5','\uCD9C\uC11D\uC5EC\uBD80':'O'},{'\uC774\uB984':'\uC815\uC218\uC9C4','\uC8FC\uC18C':'','\uAD50\uAD6C':'3\uAD50\uAD6C','\uAD6C\uC5ED':'1\uAD6C\uC5ED','\uC18C\uC18D':'\uC77C\uBC18','\uC9C1\uBD84':'\uD300\uC6D0','\uCD9C\uC11D\uC5EC\uBD80':'X'}];
        const w=XLSX.utils.json_to_sheet(d);w['!cols']=[{wch:10},{wch:40},{wch:10},{wch:10},{wch:15},{wch:10},{wch:10}];
        const b=XLSX.utils.book_new();XLSX.utils.book_append_sheet(b,w,"\uC0D8\uD50C");XLSX.writeFile(b,"\uAD6C\uC5ED\uAD00\uB9AC_\uC0D8\uD50C.xlsx");
    };

    _w.handleFileUpload=function(e){
        const f=e.target.files[0];if(!f)return;
        const r=new FileReader();
        r.onload=function(Ev){try{
            const dt=new Uint8Array(Ev.target.result),wb=XLSX.read(dt,{type:'array'});
            const jd=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            if(jd.length>0)_PD(jd);
        }catch(er){alert("\uC5D0\uB7EC:"+er.message)}};
        r.readAsArrayBuffer(f);e.target.value='';
    };

    async function _PD(dt){
        if(!_G)return;
        _d.getElementById('statusMsg').innerText="\uCC98\uB9AC \uC911...";
        _D.forEach(o=>{if(o.mk)o.mk.setMap(null)});_D=[];
        let tv=[],ti=[];
        for(const[i,r]of dt.entries()){
            const n=r['\uC774\uB984']||'\uBBF8\uC0C1',p=r['\uAD50\uAD6C']||'\uBBF8\uC9C0\uC815',z=r['\uAD6C\uC5ED']||'\uBBF8\uC9C0\uC815',g=r['\uC18C\uC18D']||'\uAE30\uD0C0',a=r['\uC8FC\uC18C']||'';
            const P={id:i,n,a,p,z,g,rl:r['\uC9C1\uBD84']||'-',at:r['\uCD9C\uC11D\uC5EC\uBD80']||'X',mk:null,mt:z.replace(/[^0-9]/g,''),ck:true};
            if(a){await new Promise(rs=>{
                _G.addressSearch(a,(res,st)=>{
                    if(st===kakao.maps.services.Status.OK){
                        const lt=parseFloat(res[0].y),ln=parseFloat(res[0].x),ci=_PC[p]||_PC['default'],mi=_CS(ci.h,P.mt);
                        P.mk=new kakao.maps.Marker({map:_M,position:new kakao.maps.LatLng(lt,ln),title:`${n} (${g})`,image:mi,zIndex:1});
                        P.oi=mi;kakao.maps.event.addListener(P.mk,'click',()=>_HP(P.id));tv.push(P);
                    }else{ti.push(P)}
                    rs();
                });
            })}else{ti.push(P)}
            if(i%10===0)_d.getElementById('statusMsg').innerText=`${i}\uAC74...`;
        }
        _D=[...tv,...ti];
        _d.getElementById('statusMsg').innerText="\uC644\uB8CC";
        _d.getElementById('totalCount').innerText=_D.length;
        _UI();
        if(tv.length>0){const b=new kakao.maps.LatLngBounds();tv.forEach(x=>b.extend(x.mk.getPosition()));_M.setBounds(b)}
    }

    function _UI(){
        _S={};
        _D.forEach(x=>{
            if(!_S[x.p])_S[x.p]={t:0,z:{}};_S[x.p].t++;
            if(!_S[x.p].z[x.z])_S[x.p].z[x.z]={t:0,g:{}};_S[x.p].z[x.z].t++;
            if(!_S[x.p].z[x.z].g[x.g])_S[x.p].z[x.z].g[x.g]=0;_S[x.p].z[x.z].g[x.g]++;
        });
        _RT();_RP();_US();
    }

    function _RT(){
        const c=_d.getElementById('statsTreeContainer');c.innerHTML='';
        Object.keys(_S).sort().forEach(pk=>{
            const pd=_S[pk],cc=(_PC[pk]||_PC['default']).l,dv=_d.createElement('div');
            dv.className="border rounded bg-white overflow-hidden shadow-sm text-sm";
            let zh='';
            Object.keys(pd.z).sort().forEach(zk=>{
                const zd=pd.z[zk];let gh='';
                Object.keys(zd.g).sort().forEach(gk=>{gh+=`<div class="flex items-center gap-1 bg-gray-50 px-1.5 py-0.5 rounded border text-[11px] text-gray-600 whitespace-nowrap"><input type="checkbox" checked onchange="toggleGroup('group','${pk}|${zk}|${gk}',this.checked)" class="w-3 h-3 rounded text-blue-600"><span>${gk} ${zd.g[gk]}</span></div>`});
                zh+=`<div class="p-2 pl-4"><div class="flex items-center gap-2 mb-1"><input type="checkbox" checked onchange="toggleGroup('zone','${pk}|${zk}',this.checked)" class="rounded text-blue-600 focus:ring-0"><span class="font-semibold text-gray-700 text-xs">\u2514 ${zk}</span><span class="text-[10px] text-gray-400">(${zd.t}\uBA85)</span></div><div class="flex flex-wrap gap-1 pl-5">${gh}</div></div>`;
            });
            dv.innerHTML=`<div class="flex items-center justify-between p-2 bg-gray-50 border-b cursor-pointer hover:bg-gray-100"><div class="flex items-center gap-2"><input type="checkbox" checked onchange="toggleGroup('parish','${pk}',this.checked)" class="rounded text-blue-600 focus:ring-0"><span class="w-2 h-2 rounded-full ${cc}"></span><span class="font-bold text-gray-800">${pk}</span></div><span class="text-xs font-bold bg-white border px-1.5 rounded">${pd.t}\uBA85</span></div><div class="divide-y divide-gray-100">${zh}</div>`;
            c.appendChild(dv);
        });
    }

    _w.toggleGroup=function(l,k,c){
        _D.forEach(p=>{let m=false;if(l=='parish'&&p.p===k)m=true;else if(l=='zone'){const[x,y]=k.split('|');if(p.p===x&&p.z===y)m=true}else if(l=='group'){const[x,y,z]=k.split('|');if(p.p===x&&p.z===y&&p.g===z)m=true}if(m){p.ck=c;_MV(p)}});
        _RP();_US();
    };

    _w.togglePerson=function(i,c){const p=_D.find(x=>x.id===i);if(p){p.ck=c;_MV(p);_US()}};
    
    _w.toggleAll=function(c){_D.forEach(p=>{p.ck=c;_MV(p)});_d.querySelectorAll('input[type="checkbox"]').forEach(x=>x.checked=c);_RP();_US()};

    function _MV(p){if(p.mk)p.mk.setMap(p.ck?_M:null)}

    function _US(){
        const ck=_D.filter(x=>x.ck),c=_d.getElementById('selectedCount'),t=_d.getElementById('selectionTags');
        c.innerText=ck.length;t.innerHTML='';
        if(ck.length===0){t.innerHTML='<span class="text-gray-400 px-1">\uC120\uD0DD\uB41C \uC778\uC6D0 \uC5C6\uC74C</span>';return}
        const sm={};ck.forEach(x=>{if(!sm[x.g])sm[x.g]=0;sm[x.g]++});
        Object.keys(sm).sort().forEach(k=>{const s=_d.createElement('span');s.className="bg-white text-blue-600 border border-blue-200 px-1.5 py-0.5 rounded shadow-sm font-medium";s.innerText=`${k} ${sm[k]}`;t.appendChild(s)});
    }

    function _RP(){
        const tb=_d.getElementById('personList'),fg=_d.createDocumentFragment();tb.innerHTML='';
        _D.forEach(p=>{
            const tr=_d.createElement('tr'),hx=(_PC[p.p]||_PC['default']).h;
            tr.id=`row-${p.id}`;tr.className=`border-b list-row ${p.a?'':'no-marker-row'}`;
            tr.innerHTML=`<td class="px-2 py-2 text-center"><input type="checkbox" ${p.ck?'checked':''} onchange="togglePerson(${p.id},this.checked)" class="rounded text-blue-600 focus:ring-0"></td><td class="px-2 py-2 text-center" onclick="highlightPerson(${p.id})"><span class="text-xs font-bold px-2 py-1 rounded whitespace-nowrap" style="background-color:${hx}1A;color:${hx};border:1px solid ${hx}40">${p.p} ${p.z}</span><div class="text-[10px] text-gray-500 mt-1">${p.g}</div></td><td class="px-2 py-2 font-medium text-gray-800 text-sm truncate" onclick="highlightPerson(${p.id})">${p.n}</td><td class="px-2 py-2 text-center text-xs text-gray-600 truncate" onclick="highlightPerson(${p.id})">${p.rl}</td><td class="px-2 py-2 text-xs text-gray-500 truncate" title="${p.a}" onclick="highlightPerson(${p.id})">${p.a||'<span class="text-red-400">\uC8FC\uC18C \uC5C6\uC74C</span>'}</td><td class="px-2 py-2 text-center" onclick="highlightPerson(${p.id})"><span class="px-2 py-0.5 rounded-full text-xs font-bold text-white ${p.at==='O'?'bg-green-500':'bg-gray-400'}">${p.at}</span></td>`;
            fg.appendChild(tr);
        });
        tb.appendChild(fg);
    }

    function _CS(c,t){
        const s=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="35" height="45"><path fill="${c}" stroke="white" stroke-width="1" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="4" fill="rgba(0,0,0,0.1)"/><text x="12" y="13" font-size="10" font-weight="bold" fill="white" text-anchor="middle" font-family="sans-serif">${t}</text></svg>`;
        return new kakao.maps.MarkerImage('data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(s),new kakao.maps.Size(35,45),{offset:new kakao.maps.Point(17,45)});
    }

    _w.highlightPerson=function(i){_HP(i)};
    function _HP(i){
        const p=_D.find(x=>x.id===i);if(!p)return;
        if(_SM){const pv=_D.find(x=>x.mk===_SM);if(pv){pv.mk.setImage(pv.oi);pv.mk.setZIndex(1)}}
        if(p.mk){
            if(!p.ck){alert("\uCCB4\uD06C \uD574\uC81C\uB41C \uC778\uC6D0\uC785\uB2C8\uB2E4.");p.ck=true;_MV(p);_US();_d.querySelector(`#row-${i} input`).checked=true}
            const hi=_CS('#FF0000',p.mt);p.mk.setImage(hi);p.mk.setZIndex(999);_SM=p.mk;_M.panTo(p.mk.getPosition());
        }else{alert("\uC704\uCE58 \uC815\uBCF4 \uC5C6\uC74C.")}
        _d.querySelectorAll('.selected-row').forEach(e=>e.classList.remove('selected-row'));
        const r=_d.getElementById(`row-${i}`);if(r){r.classList.add('selected-row');r.scrollIntoView({behavior:'smooth',block:'center'})}
    }

    _w.resetAll=function(){
        if(!confirm("\uCD08\uAE30\uD654 \uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?"))return;
        _D.forEach(d=>{if(d.mk)d.mk.setMap(null)});_D=[];
        _d.getElementById('statsTreeContainer').innerHTML='<div class="text-center py-10 text-gray-400 text-xs">\uB370\uC774\uD130\uB97C \uC5C5\uB85C\uB4DC\uD558\uC138\uC694.</div>';
        _d.getElementById('personList').innerHTML='';
        _d.getElementById('totalCount').innerText='0';
        _d.getElementById('selectedCount').innerText='0';
        _d.getElementById('selectionTags').innerHTML='';
    };
})(window,document);
</script>
</body>
</html>
